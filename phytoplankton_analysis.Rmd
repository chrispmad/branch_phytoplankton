---
title: "Phytoplankton Analysis"
author: "Chris Madsen"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F, fig.width = 12, fig.height = 6)

library(tidyverse)
library(crosstalk)
library(plotly)
library(patchwork)
library(rstatix)
library(ggpubr)

d = readxl::read_excel("output/data_both_projects_rolled_up.xlsx")

col_scheme = ggplot2::scale_fill_manual(
  values = c("Cyanophyceae" = 'lightblue',
             "Chlorophyceae" = 'orange',
             "Bacillariophyceae" = 'red',
             "Dinophyceae" = 'darkblue',
             "Chryso- & Cryptophyceae" = 'lightyellow')
)

my_plot_theme = theme_minimal() + 
  theme(axis.text = element_text(size = 13),
        axis.title = element_text(size = 15))
```

```{r create_plotting_functions}
make_plot_by_month = function(d,vars,var_label,proj, species_count = F){
  if(!species_count){
    d_summarised = d |> 
      tidyr::pivot_longer(cols = vars, names_to = "lab", values_to = 'y') |> 
      dplyr::mutate(lab = ifelse(stringr::str_detect(lab,"^DB"),"Darren","Lidija")) |> 
      dplyr::filter(project == proj) |> 
      dplyr::group_by(project, year, basin, month, class.name, lab) |> 
      dplyr::reframe(y = sum(y, na.rm=T))
    
    ggplot(d_summarised, 
           aes(x = month, y = y, fill = class.name)) + 
      col_scheme +
      geom_col() + 
      labs(y = paste0("Phytoplankton ", var_label), fill = '') +
      facet_wrap(basin ~ lab, ncol = 2, strip.position = "right") +
      theme(legend.position = 'bottom') + 
      my_plot_theme
  } else {
    # Darren's data
    db_d = d |> 
      dplyr::select(project, year, basin, month, DB.cells.ml, DB.mm3.l, spp) |> 
      # Ensure rows we're keeping rows where DB reported values
      dplyr::filter(DB.cells.ml != 0, DB.mm3.l != 0, !is.na(DB.cells.ml), !is.na(DB.mm3.l)) |> 
      dplyr::count(project, year, basin, month) |> 
      dplyr::mutate(lab = 'Darren')
    
    # Lidija's data
    lv_d = d |> 
      dplyr::select(project, year, basin, month, LV.cells.ml, LV.mm3.l, spp) |> 
      # Ensure rows we're keeping rows where DB reported values
      dplyr::filter(LV.cells.ml != 0, LV.mm3.l != 0, !is.na(LV.cells.ml), !is.na(LV.mm3.l)) |> 
      dplyr::count(project, year, basin, month) |> 
      dplyr::mutate(lab = 'Lidija')
    
    d_for_plot = dplyr::bind_rows(db_d, lv_d) |> 
      dplyr::filter(project == proj)
    
    ggplot(d_for_plot, 
           aes(x = month, y = n)) + 
      geom_point() + 
      scale_y_continuous(limits = c(0, max(d_for_plot$n)), breaks = seq(0,50,5)) +
      labs(y = paste0("Phytoplankton ", var_label)) +
      facet_wrap(basin ~ lab, ncol = 2, strip.position = "right") +
      theme(legend.position = 'bottom') + 
      my_plot_theme
  }
}

```

# Sections {.tabset}

## Stats {.tabset}

### Descriptive Statistics

```{r}
d |> 
  tidyr::pivot_longer(cols = c(LV.cells.ml,LV.mm3.l,DB.cells.ml,DB.mm3.l)) |> 
  dplyr::mutate(value = round(value, 4)) |> 
  dplyr::group_by(name) |> 
  dplyr::reframe(min_value = min(value),
                 max_value = max(value),
                 median_value = median(value),
                 mean_value = mean(value)) |> 
  dplyr::arrange(dplyr::desc(max_value)) |> 
  dplyr::rename(variable = name) |> 
  knitr::kable()
```

### Pairwise T-test {.tabset}

#### Table

```{r}
d_for_t_tests = d |> 
  tidyr::pivot_longer(cols = c(starts_with("DB"),starts_with("LV")), names_to = "var", values_to = 'value') |> 
  dplyr::mutate(lab = ifelse(stringr::str_detect(var,"^DB"),"Darren","Lidija")) |> 
  dplyr::mutate(var_full = stringr::str_remove(var,"^[A-Z]{2}\\.")) |> 
  dplyr::mutate(var_full = ifelse(var_full == 'cells.ml', 'abundance','biovolume')) |> 
  dplyr::select(project, year, lab, basin, var_full, value) |> 
  group_by(project, year, basin, var_full) |> 
  group_split()

t_test_results = d_for_t_tests |> 
  purrr::map( ~ {
    rstatix::pairwise_t_test(
      data = .x,
      value ~ lab, pool.sd = FALSE,
      p.adjust.method = "bonferroni"
    ) |> 
      dplyr::mutate(variable = unique(.x$var_full),
                    year = unique(.x$year),
                    basin = unique(.x$basin),
                    project = unique(.x$project)) |> 
      dplyr::select(variable,year,basin,project, group1:p.adj.signif)
  }) |> 
  dplyr::bind_rows()

knitr::kable(t_test_results)

t_test_results_xy = t_test_results |> 
  add_xy_position(x = "lab", step.increase = 1)

boxplot_res_l = d_for_t_tests |> 
  purrr::map( ~ {
    filters = .x |> dplyr::select(var_full, basin, year, project, variable = var_full) |> dplyr::distinct()
    
    relevant_t_test_results = t_test_results_xy |> 
      dplyr::inner_join(filters, by = join_by(variable, year, basin, project))
    
    y_var_label = ifelse(relevant_t_test_results$variable == "abundance",
                         "Phytoplankton Abundance (cells*mL^-1)",
                         "Phytoplankton Biovolume (mm^3*L^-1)")
    
    ggboxplot(.x, x = "lab", y = "value") +
      stat_pvalue_manual(relevant_t_test_results, hide.ns = TRUE) +
      labs(x = "Lab", y = y_var_label,
           title = paste0(relevant_t_test_results$project," ",
                          relevant_t_test_results$basin,", ",
                          relevant_t_test_results$year,": ",
                          str_to_title(relevant_t_test_results$variable),
                          " (adj. p-value: ",
                          relevant_t_test_results$p.adj,
                          ")"))
  })

```

#### Boxplots
```{r}
boxplot_res_l
```

#### Significant Differences

```{r}
#1.	Can you look to see if there are significant differences between the larger species between the 2 labs each month and each year (for example, cyanophyceae, Chlorophyceae, etc.) and Iâ€™m wondering if you could put a table together of the % differences?

biov_by_class = d |> 
  dplyr::filter(year == 2023, project == 'Alouette') |> 
  dplyr::select(-c(edibility,DB.cells.ml,LV.cells.ml)) |> 
  tidyr::pivot_longer(cols = c(DB.mm3.l, LV.mm3.l)) |> 
  dplyr::mutate(lab = ifelse(stringr::str_detect(name,"^DB"),"Darren","Lidija")) |> 
  dplyr::group_by(project, year, month, basin, lab, class.name) |>
  # Find the sum of biovolume per class name; keep the top two.
  dplyr::mutate(biov_of_class = sum(value,na.rm=T)) |> 
  dplyr::arrange(project,year,month,basin,lab,class.name,dplyr::desc(biov_of_class)) |> 
  dplyr::ungroup()


# paired t-test by class.name and lab.
# Trying it out for 2023, Apr, Flagellates
d_t = d |> 
  dplyr::filter(project == 'Alouette', year == 2023, month == 'Apr', basin == 'NB') |> 
  dplyr::mutate(the_row = dplyr::row_number()) |> 
  dplyr::select(-c(DB.cells.ml,LV.cells.ml))

lab_paired_t_test_results = d |> 
  dplyr::group_by(project, year, month, basin) |> 
  dplyr::group_split() |> 
  purrr::map( ~ {
    tryCatch(
      expr = {
        t.test(.x$DB.mm3.l, .x$LV.mm3.l, paired = T) |> 
          broom::tidy() |> 
          dplyr::mutate(test_run = TRUE,
                        project = unique(.x$project), 
                        year = unique(.x$year),
                        month = unique(.x$month),
                        basin = unique(.x$basin)) |> 
          dplyr::select(test_run,project,year,month,basin,dplyr::everything())},
      error = function(e) return(data.frame(test_run = FALSE))
    )
  },.progress=T) |> 
  dplyr::bind_rows()

lab_paired_t_test_box_plots = lab_paired_t_test_results |> 
  dplyr::filter(p.value < 0.05) |> 
  dplyr::group_by(project, year, month, basin) |> 
  dplyr::group_split() |> 
  purrr::map( ~ {
    d |> 
      dplyr::filter(year == .x$year, month == .x$month,
                    basin == .x$basin, project == .x$project) |> 
      dplyr::select(-c(DB.cells.ml,LV.cells.ml)) |> 
      tidyr::pivot_longer(cols = c(DB.mm3.l,LV.mm3.l)) |> 
      ggplot(aes(x = class.name, y = value, fill = name)) + 
      geom_boxplot() + 
      labs(x = "Class", y = "Biovolume", fill = "Lab",
           title = paste0("Significant Differences between Labs by Class"),
           subtitle = paste0(.x$month," ",.x$year,", ",.x$basin,", ",.x$project)) + 
      theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
  })

biov_by_class
```

```{r}
lab_paired_t_test_box_plots
```

## Lab Comparison Plots {.tabset}

### Wahleach {.tabset}

#### Abundance by Month - 2023
```{r}
d |> 
  dplyr::filter(year == 2023) |> 
  make_plot_by_month(vars = c("DB.cells.ml","LV.cells.ml"),
                     var_label = "Abundance (cells*mL^-1)", 
                     proj = 'Wahleach')
```

#### Abundance by Month - 2024
```{r}
make_plot_by_month(d[d$year == 2024,], vars = c("DB.cells.ml","LV.cells.ml"), "Abundance (cells*mL^-1)", proj = 'Wahleach')
```

#### Biovolume by Month - 2023
```{r}
make_plot_by_month(d[d$year == 2023,], vars = c("DB.mm3.l","LV.mm3.l"), "Biovolume (mm^3*L^-1)", proj = 'Wahleach')
```

#### Biovolume by Month - 2024
```{r}
make_plot_by_month(d[d$year == 2024,], vars = c("DB.mm3.l","LV.mm3.l"), "Biovolume (mm^3*L^-1)", proj = 'Wahleach')
```

#### Species Richness by Month - 2023
```{r}
d |> 
  dplyr::filter(year == 2023) |> 
  make_plot_by_month(var_label = "Species Richness Count", 
                     proj = 'Wahleach', 
                     species_count = T)
```

#### Species Richness by Month - 2024
```{r}
d |> 
  dplyr::filter(year == 2024) |> 
  make_plot_by_month(var_label = "Species Richness Count", 
                     proj = 'Wahleach', 
                     species_count = T)
```

### Alouette {.tabset}

#### Abundance by Month - 2023
```{r}
make_plot_by_month(d[d$year == 2023,], vars = c("DB.cells.ml","LV.cells.ml"), "Abundance (cells*mL^-1)", proj = 'Alouette')
```

#### Abundance by Month - 2024
```{r}
make_plot_by_month(d[d$year == 2024,], vars = c("DB.cells.ml","LV.cells.ml"), "Abundance (cells*mL^-1)", proj = 'Alouette')
```

#### Biovolume by Month - 2023
```{r}
make_plot_by_month(d[d$year == 2023,], vars = c("DB.mm3.l","LV.mm3.l"), "Biovolume (mm^3*L^-1)", proj = 'Alouette')
```

#### Biovolume by Month - 2024
```{r}
make_plot_by_month(d[d$year == 2024,], vars = c("DB.mm3.l","LV.mm3.l"), "Biovolume (mm^3*L^-1)", proj = 'Alouette')
```

#### Species Richness by Month - 2023
```{r}
d |> 
  dplyr::filter(year == 2023) |> 
  make_plot_by_month(var_label = "Species Richness Count", 
                     proj = 'Alouette', 
                     species_count = T)
```

#### Species Richness by Month - 2024
```{r}
d |> 
  dplyr::filter(year == 2024) |> 
  make_plot_by_month(var_label = "Species Richness Count", 
                     proj = 'Alouette', 
                     species_count = T)
```
